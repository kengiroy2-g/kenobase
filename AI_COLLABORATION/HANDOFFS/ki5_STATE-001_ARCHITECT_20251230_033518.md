---
status: COMPLETE
task: STATE-001
role: ARCHITECT
phase: ARCHITECT
files_changed:
  - AI_COLLABORATION/HANDOFFS/ki5_STATE-001_ARCHITECT_20251230_033518.md
summary:
  - Context sync done: SYSTEM_STATUS.md read (json missing), ADR_AXIOM_FIRST_FRAMEWORK reviewed, git status captured
  - Granularity set to global per draw; semantics aligned to COOLDOWN/HOT/RECOVERY/NORMAL using spieleinsatz/jackpot/rolling_cv
  - Target metric planned as accuracy of state labels vs economic_state baseline plus change-point boundary precision/recall
  - Plan covers data prep (DataLoader + feature engineering) and train/test split per ADR (pre-2024 train, 2024+ test)
  - Two-stage pipeline defined: ruptures change-points -> hmmlearn HMM with segment-aware fitting and Viterbi decoding
  - Integration points: new analysis/regime_detection.py, exports via analysis __init__, config.regime_detection block, requirements adds ruptures/hmmlearn
  - Validation plan: agreement vs economic_state labels, likelihood on holdout, changepoint F1; repro command to be added in implementation
---
# Rule Confirmation
- Rule 1 (SYSTEM_STATUS + ADR/Docs + git status): UNVERIFIED (SYSTEM_STATUS.json missing; SYSTEM_STATUS.md read; git status collected)
- Rule 2 (granularity stated): global
- Rule 3 (semantics defined): states={COOLDOWN,HOT,RECOVERY,NORMAL}, features={spieleinsatz,jackpot,rolling_cv}
- Rule 4 (target metric): accuracy
- Rule 5 (helper-only boundaries): CONFIRMED
- Rule 6 (reproducibility): UNVERIFIED

## Task Setup
- Granularity: global
- Semantics: per-draw regime from spieleinsatz/jackpot/rolling_cv mapped to COOLDOWN/HOT/RECOVERY/NORMAL; change-points segment feature trajectories
- Target metric: accuracy (state label agreement) with supporting change-point boundary F1 and HMM log-likelihood on test

## Repro Commands
- UNVERIFIED (pipeline not yet implemented)

# Implementierungsplan
1) Observables & semantics: Use DataLoader/DrawResult outputs to build per-draw feature vectors [spieleinsatz, jackpot, rolling_cv, optional n_hits variance]; enforce sorting by date and align numbers_range to config.games. Map HMM latent states to economic_state labels via majority vote against rule-based classify_economic_state to keep semantics consistent.
2) Data prep & splits: Add helper to load draws (keno default) and derive features; apply ADR train/test split (train < 2024-01-01, test >= 2024-01-01). Handle missing features via imputation (median for numeric, mask flag) and persist scaler parameters on train only.
3) Change-point stage (ruptures): Configure algorithm in config.regime_detection (default PELT/model="rbf"/penalty/min_size). Run on multi-variate feature matrix; output segment boundaries; expose boundary diagnostics (n_segments, mean segment length) for validation.
4) HMM stage (hmmlearn): Fit GaussianHMM on segmented train data (optionally segment-weighted initialization). Tune n_states (default 4) and covariance_type via config; use Viterbi decode on train/test to get per-draw latent states; map to labels via step 1 mapping; optionally re-estimate on segments with high mismatch vs rule-based labels.
5) Integration & API: Implement `kenobase.analysis.regime_detection` with dataclasses for RegimeDetectionConfig/Result, functions `detect_regimes(draws, config)` and `train_hmm(features, boundaries, config)`. Update `kenobase/analysis/__init__.py` exports; add `regime_detection` config block (change-point + HMM + thresholds + data split) and extend economic_state config if shared thresholds are needed.
6) Validation & acceptance: Define metrics: (a) label accuracy/F1 vs classify_economic_state baseline on test, (b) change-point boundary precision/recall vs baseline state transitions, (c) HMM test log-likelihood delta vs null (iid features). Acceptance: accuracy >=0.65, boundary F1 >=0.60, log-likelihood improvement >0 on test; add unit tests for feature extraction, boundary detection determinism, label mapping, and config wiring. Add requirements entries for `ruptures` and `hmmlearn`; document intended repro command (pending implementation) in README/regime doc.