---
status: COMPLETE
task: STRAT-004
role: EXECUTOR
phase: EXECUTOR
files_changed:
  - scripts/backtest_cycle_surfing.py
summary:
  - Created scripts/backtest_cycle_surfing.py combining regime_detection.py + temporal_cycles.py
  - Implements HMM-based regime detection with train/test split at 2024-01-01 (configurable)
  - Adds temporal filters: weekday bias (derived from train chi2) + holiday proximity (3-day window)
  - Decision logic: PLAY if regime is favorable AND weekday passes AND not near holiday
  - Hit metric: fraction of popular numbers (1-31) as ROI proxy
  - Statistical test: Mann-Whitney U (one-sided) for strategy vs baseline comparison
  - Output: results/cycle_surfing_backtest.json with full metrics and acceptance criteria
  - Backtest result: NO_IMPROVEMENT (p=0.58) - strategy shows no significant edge
---
# Rule Confirmation
- Rule 1 (SYSTEM_STATUS + ADR/Docs + git status): CONFIRMED
- Rule 2 (granularity stated): per-draw
- Rule 3 (semantics defined): regime_state (HMM latent) + weekday chi2 + holiday_proximity -> PLAY/AVOID decision
- Rule 4 (target metric): ROI vs. baseline (Mann-Whitney U p<0.05)
- Rule 5 (helper-only boundaries): CONFIRMED
- Rule 6 (reproducibility): `python scripts/backtest_cycle_surfing.py --data data/raw/keno/KENO_ab_2022_bereinigt.csv --train-split 2024-06-01` -> `results/cycle_surfing_backtest.json`

## Task Setup
- Granularity: per-draw
- Semantics: regime_state (NORMAL/GROWTH/COOLDOWN/CRISIS) + weekday (0-6) + holiday proximity (bool) -> PLAY/AVOID
- Target metric: hit_rate improvement + Mann-Whitney U p-value < 0.05

## Repro Commands
```bash
python scripts/backtest_cycle_surfing.py --data data/raw/keno/KENO_ab_2022_bereinigt.csv --train-split 2024-06-01
```
Output: `results/cycle_surfing_backtest.json`

## Implementation Details

### Created File: scripts/backtest_cycle_surfing.py

**Purpose:** Orchestrates cycle surfing strategy backtest combining:
1. `kenobase.analysis.regime_detection.detect_regimes()` - HMM regime detection
2. `kenobase.analysis.temporal_cycles.analyze_dimension()` - Weekday chi2 test
3. Holiday proximity filtering using `GERMAN_HOLIDAYS`

**Key Components:**
- `CycleSurfingConfig`: Dataclass with train_split_date, favorable/avoid regimes, filter toggles
- `BacktestResult`: Dataclass with metrics (n_train, n_test, play/avoid counts, hit rates, Mann-Whitney stats)
- `is_near_holiday()`: Checks if date is within window of German holidays
- `compute_hit_metric()`: ROI proxy using popular number (1-31) fraction
- `derive_weekday_filter_from_train()`: Derives favorable weekdays from train chi2 (p<0.05)
- `run_backtest()`: Main backtest loop with decision logic
- `main()`: CLI entry point with argparse

**Decision Logic:**
```
PLAY if:
  - regime NOT in {COOLDOWN, CRISIS}
  - weekday in favorable set (if chi2 significant in train)
  - NOT near German holiday (within 3 days)
Otherwise: AVOID
```

### Backtest Results (577 test draws)

| Metric | Value |
|--------|-------|
| Train draws | 880 |
| Test draws | 577 |
| PLAY decisions | 536 (92.9%) |
| AVOID decisions | 41 |
| Holiday avoided | 41 |
| Baseline hit rate | 0.4438 |
| Strategy hit rate | 0.4437 |
| Improvement | -0.0001 |
| Mann-Whitney p | 0.58 |

**Verdict:** NO_IMPROVEMENT - Strategy shows no statistically significant edge.

**Note on Regime Detection:** All HMM states map to NORMAL due to insufficient variability in economic metadata (spieleinsatz/jackpot). The regime filter is effectively inactive. Strategy benefit comes only from holiday avoidance (41 draws avoided).

### Acceptance Criteria Evaluation

| Criterion | Target | Actual | Status |
|-----------|--------|--------|--------|
| ROI improvement | > 0 | -0.0001 | FAIL |
| Statistical significance | p < 0.05 | p = 0.58 | FAIL |
| Overall | PASS | FAIL | **NOT MET** |

The strategy does not provide a statistically significant improvement over baseline. This is a valid scientific finding - not all hypothesized strategies will show positive results.

**Handoff erstellt:** `AI_COLLABORATION/HANDOFFS/ki2_STRAT-004_EXECUTOR_20251230_070258.md`
