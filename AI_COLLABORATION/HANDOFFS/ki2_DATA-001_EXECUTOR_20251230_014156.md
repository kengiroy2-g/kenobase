---
status: COMPLETE
task: DATA-001
role: EXECUTOR
phase: EXECUTOR
files_changed:
  - kenobase/core/timeline.py (NEW - 378 lines)
  - tests/unit/test_timeline.py (NEW - 401 lines)
  - scripts/build_timeline_grid.py (NEW - 125 lines)
  - kenobase/core/data_loader.py (MODIFIED - added Lotto bereinigt + EJ E-format parsers)
  - data/processed/timeline_grid.parquet (NEW OUTPUT - 115KB)
  - results/timeline_grid_summary.json (NEW OUTPUT)
summary:
  - Implemented TimelineGrid class for daily grid alignment of multi-game data
  - Supports KENO (daily), Lotto (Wed+Sat), EuroJackpot (Tue+Fri) draw schedules
  - Added NaN and forward-fill strategies for non-draw days
  - Created to_dataframe() and to_numbers_matrix() export methods
  - Added parquet export with tuple/matrix modes
  - Implemented get_draw_coverage() and get_joint_draw_days() analytics
  - Fixed data_loader to parse LOTTO_ab_2022_bereinigt.csv (L1-L6 format)
  - Fixed data_loader to parse EJ_ab_2022_bereinigt.csv (E1-E5/Euro1-2 format)
---
# Rule Confirmation
- Rule 1 (SYSTEM_STATUS + ADR/Docs + git status): CONFIRMED (read PROXY handoff)
- Rule 2 (granularity stated): per-game (daily grid with game-specific draw masks)
- Rule 3 (semantics defined): date=index, {game}_has_draw=bool, {game}_z1..zN=int
- Rule 4 (target metric): alignment coverage / enable COUPLE-001/002 downstream
- Rule 5 (helper-only boundaries): CONFIRMED (new core module kenobase/core/timeline.py)
- Rule 6 (reproducibility): see Repro Commands

## Task Setup
- Granularity: per-game (KENO=daily, Lotto=Wed+Sat, EuroJackpot=Tue+Fri)
- Semantics: TimelineGrid with daily DatetimeIndex, game-specific columns
- Target metric: Enable cross-game coupling analysis (COUPLE-001, COUPLE-002)

## Repro Commands
```bash
# Build timeline grid
python scripts/build_timeline_grid.py --use-defaults \
  --output data/processed/timeline_grid.parquet \
  --json-summary results/timeline_grid_summary.json

# Run unit tests
python -m pytest tests/unit/test_timeline.py -v

# Verify output
python -c "import pandas as pd; df=pd.read_parquet('data/processed/timeline_grid.parquet'); print(df.shape, df.columns.tolist()[:10])"
```

## Implementation Details

### TimelineGrid Class (kenobase/core/timeline.py)

Core dataclass for multi-game timeline alignment:

```python
@dataclass
class TimelineGrid:
    games: dict[str, GameData]
    start_date: Optional[datetime]
    end_date: Optional[datetime]
    fill_strategy: Literal["nan", "ffill"]
```

**Key Methods:**
- `add_game(game_name, draws)`: Add game draws to grid
- `add_game_from_csv(game_name, path)`: Load from CSV directly
- `to_dataframe()`: Export as DataFrame with {game}_has_draw, {game}_numbers columns
- `to_numbers_matrix()`: Export with expanded z1...zN columns per game
- `to_parquet(path, mode)`: Save to parquet (tuple or matrix mode)
- `get_draw_coverage()`: Statistics per game
- `get_joint_draw_days()`: Find common draw dates

### Data Loader Enhancements

Added support for two additional CSV formats:

1. **Lotto Bereinigt** (LOTTO_ab_2022_bereinigt.csv):
   - Format: `Datum;L1;L2;L3;L4;L5;L6;Zusatzzahl;Superzahl;...`
   - Parser: `_parse_lotto_bereinigt()`

2. **EuroJackpot E-Format** (EJ_ab_2022_bereinigt.csv):
   - Format: `Datum;E1;E2;E3;E4;E5;Euro1;Euro2;...`
   - Parser: Updated `_parse_eurojackpot()` with E-format detection

### Test Coverage

24 tests in `tests/unit/test_timeline.py`:
- Draw pattern constants
- TimelineGrid initialization and game addition
- DataFrame conversion (NaN/ffill strategies)
- Numbers matrix expansion
- Coverage statistics
- Joint draw day detection
- Parquet export
- Convenience function

### Output Files

1. **timeline_grid.parquet** (115KB):
   - 1457 rows (days from 2022-01-03 to 2025-12-29)
   - 45 columns (has_draw flags + individual numbers per game)
   - Matrix mode with keno_z1...z20, lotto_z1...z6, eurojackpot_z1...z5+euro1+euro2

2. **timeline_grid_summary.json**:
   - Date range, game list, fill strategy
   - Coverage stats: KENO 100%, Lotto 28.6%, EuroJackpot 27.7%

## Downstream Enablement

The TimelineGrid now enables:
- **COUPLE-001**: Transfer Entropy analysis requires aligned daily time series
- **COUPLE-002**: Cross-Spectrum/Phase analysis requires uniform sampling
- **STATE-001**: Regime detection across games with common timeline

## Notes

- EuroJackpot actual weekly rate is 1.94/week (expected 2/week) due to date range edges
- Lotto actual weekly rate is 2.0/week as expected
- KENO has 100% coverage (daily draws)
